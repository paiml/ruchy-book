// File: web_server.ruchy
// HTTP server with routing and middleware

use std::net::http;

let server = http::Server::new("0.0.0.0:8080")

// Middleware for logging
server.use(|req, res, next| {
    let start = current_time_ms()
    next()
    let duration = current_time_ms() - start
    println(f"{req.method} {req.path} - {res.status} ({duration}ms)")
})

// Routes
server.get("/", |req, res| {
    res.html("<h1>Welcome to Ruchy Server!</h1>")
})

server.get("/api/users", |req, res| {
    let users = [
        {id: 1, name: "Alice", email: "alice@example.com"},
        {id: 2, name: "Bob", email: "bob@example.com"}
    ]
    res.json(users)
})

server.post("/api/users", |req, res| {
    let user = req.json()
    println(f"Creating user: {user.name}")
    user.id = generate_id()
    user.created = current_datetime()
    res.status(201).json(user)
})

// Static files
server.static("/public", "./static")

// Start server
println(f"ðŸš€ Server running on http://localhost:8080")
server.listen()